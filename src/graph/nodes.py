"""–£–∑–ª—ã LangGraph –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤"""
import streamlit as st
import pandas as pd
from typing import Dict, List, Optional
from src.models import AgentState
from src.services import AIService, DataService, SearchService
from src.services.queue_service import queue_aware_generation
from src.constants import SYSTEM_PROMPTS, REPORT_DATA_DESCRIPTIONS
from src.utils.text_utils import execute_generated_code


class BaseNode:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —É–∑–ª–æ–≤ LangGraph"""

    def __init__(self, ai_service: AIService):
        self.ai_service = ai_service


class RouterNode(BaseNode):
    """–£–∑–µ–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å ‚Äî –æ–±—â–∏–π, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –∏–ª–∏ –æ—Ç—á–µ—Ç–Ω—ã–π."""

    def __init__(self, ai_service: AIService, search_service: SearchService):
        super().__init__(ai_service)
        self.search_service = search_service

    def __call__(self, state: AgentState) -> AgentState:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫ –∫–∞–∫–æ–º—É —Ç–∏–ø—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å (–æ–±—â–∏–π, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –æ—Ç—á–µ—Ç—ã),
        –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.
    
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `AgentState` —Å –∫–ª—é—á–∞–º–∏:
            - route_decision: general | documentation | elasticsearch_based | all_reports_fallback
            - report_options: —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
            - waiting_for_selection: True, –µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä –æ—Ç—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        """

        user_query = state['user_input']
        print(f"–ú–∞—Å—Ç–µ—Ä-—Ä–æ—É—Ç–µ—Ä –ø–æ–ª—É—á–∏–ª –∑–∞–ø—Ä–æ—Å: '{user_query}'")

        master_decision = self.ai_service.master_router_decision(user_query)
        print(f"–†–µ—à–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-—Ä–æ—É—Ç–µ—Ä–∞: {master_decision}")

        if master_decision == "general_question":
            state["route_decision"] = "general"
            state["report_options"] = []
            state["waiting_for_selection"] = False
            state["selected_report"] = "general"
        elif master_decision == "documentation_search":
            state["route_decision"] = "documentation"
            state["report_options"] = []
            state["waiting_for_selection"] = False
            state["selected_report"] = "documentation"
        else:
            ordered_reports = self.search_service.get_ordered_report_options(user_query)

            if ordered_reports:
                state["route_decision"] = "elasticsearch_based"
                state["report_options"] = ordered_reports
                state["waiting_for_selection"] = True
            else:
                from src.models import PREDEFINED_REPORTS
                state["route_decision"] = "all_reports_fallback"
                state["report_options"] = PREDEFINED_REPORTS.copy()
                state["waiting_for_selection"] = True

        state["generated_data"] = {}
        return state


class ReportSelectorNode(BaseNode):
    """–£–∑–µ–ª, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –≤–æ–∑–≤—Ä–∞—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–∞. –°–∞–º –≤—ã–±–æ—Ä –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ UI."""

    def __call__(self, state: AgentState) -> AgentState:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
        return state


class CodeGeneratorNode(BaseNode):
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–¥–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç—á–µ—Ç–æ–≤."""

    def generate_work_plan_code(self, query: str, df_info: str, selected_option: Optional[Dict] = None) -> str:     
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Python-–∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–ª–∞–Ω–∞–º —Ä–∞–±–æ—Ç.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –°—Ç—Ä–æ–∫–∞ —Å –∫–æ–¥–æ–º –Ω–∞ Python, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ –æ–±—ä–µ–∫—Ç–µ `df`.
        """
        pipe = get_model_pipe()
        
        try:
            if selected_option:
                modified_query = f"{query} (—Ñ–æ–∫—É—Å –Ω–∞: {selected_option['title']} - {selected_option['description']})"
            else:
                modified_query = query
            
            system_prompt = """–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç Python –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö —Å pandas.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–º—ã—Å–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            –ü–∏—à–∏ –¢–û–õ–¨–ö–û PYTHON –ö–û–î –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã–º –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú DataFrame.
            –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π 'df'.
            """
         
            user_prompt = f"""–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç DataFrame –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É: "{query}"
            –í–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ DataFrame:
            {df_info}
    
            –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•:
            1. "‚Ññ –ø/–ø" - –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)
            2. "‚Ññ —Å–∫–≤–∞–∂–∏–Ω—ã, –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ" - —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ "[–Ω–æ–º–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã] [–Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è]", –Ω–∞–ø—Ä–∏–º–µ—Ä "152s2 –î–ê–í–´–î–û–í–°–ö–û–ï"
            3. "–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç" - –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ "DD.MM.YYYY HH:MM-DD.MM.YYYY HH:MM", –Ω–∞–ø—Ä–∏–º–µ—Ä "09.10.2024 09:00-09.10.2024 13:00"
            4. "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ" - –∫–æ–¥ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä "–†–ü-24 –†–µ–º–æ–Ω—Ç –∑–∞–ø–æ—Ä–Ω–æ–π –∞—Ä–º–∞—Ç—É—Ä—ã" 
            5. "–ë—Ä–∏–≥–∞–¥–∞, —Ü–µ—Ö" - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∏–≥–∞–¥–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ[–Ω–æ–º–µ—Ä] [–Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ—Ö–∞]", –Ω–∞–ø—Ä–∏–º–µ—Ä "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ8 –¶–î–ù–ì-2"
            6. "–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è, —á" - —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä "4.0"
            7. "–°—É—Ç–æ—á–Ω—ã–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏, –¢ –≤ —Å—É—Ç." - —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä "13.0" (–≤ —Ç–æ–Ω–Ω–∞—Ö)
            8. "–ü–æ—Ç–µ—Ä–∏ –Ω–µ—Ñ—Ç–∏, —Ç" - —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä "1.1" (–≤ —Ç–æ–Ω–Ω–∞—Ö)
            9. "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" - —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ, –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å "–Ω–µ—Ç" –∏–ª–∏ –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            
            –í–ê–ñ–ù–û:
            1. –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π DataFrame 'df'.
            2. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô pd.DataFrame() –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
            3. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ—á–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞, –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è.
            
            4. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç:
               - –†–∞–∑–¥–µ–ª—è–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ "–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç" –Ω–∞ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü
               - –î–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞: df["–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç"].str.split("-", expand=True)[0]
               - –î–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è: df["–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç"].str.split("-", expand=True)[1]
               - –ò—Å–ø–æ–ª—å–∑—É–π pd.to_datetime() —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º format="%d.%m.%Y %H:%M" –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
            
            5. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤:
               - –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Å–∫–≤–∞–∂–∏–Ω—ã: df["‚Ññ —Å–∫–≤–∞–∂–∏–Ω—ã, –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ"].str.split(expand=True)[0] == "–ù–û–ú–ï–†" 
               - –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—é: df["‚Ññ —Å–∫–≤–∞–∂–∏–Ω—ã, –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ"].str.contains("–ù–ê–ó–í–ê–ù–ò–ï")
               - –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—Å–µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞: df["‚Ññ —Å–∫–≤–∞–∂–∏–Ω—ã, –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ"] == "–ù–û–ú–ï–† –ù–ê–ó–í–ê–ù–ò–ï"
            
            6. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±—Ä–∏–≥–∞–¥–∞—Ö:
               - –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É –±—Ä–∏–≥–∞–¥—ã: df["–ë—Ä–∏–≥–∞–¥–∞, —Ü–µ—Ö"].str.contains("–ù–ê–ó–í–ê–ù–ò–ï ‚Ññ–ù–û–ú–ï–†")
               - –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ü–µ—Ö—É: df["–ë—Ä–∏–≥–∞–¥–∞, —Ü–µ—Ö"].str.contains("–¶–ï–•")
            
            7. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–∏—Å–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
               - –°—Ç–æ–ª–±—Ü—ã "–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è, —á", "–°—É—Ç–æ—á–Ω—ã–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏, –¢ –≤ —Å—É—Ç.", "–ü–æ—Ç–µ—Ä–∏ –Ω–µ—Ñ—Ç–∏, —Ç" —Å–æ–¥–µ—Ä–∂–∞—Ç —á–∏—Å–ª–∞ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π
               - –ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–∞—Ö –ø—Ä–µ–æ–±—Ä–∞–∑—É–π –∏—Ö –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç: pd.to_numeric(df["–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è, —á"])
            
            DataFrame —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é 'df'.
            –í—ã–≤–æ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ print().
            –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π matplotlib —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏ –æ—Å–µ–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
            """
         
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]
         
            generation_args = {
                "max_new_tokens": 10000,
                "return_full_text": False,
                "temperature": 0.0,
                "top_p": 0.9,
                "do_sample": False
            }
         
            output = pipe(messages, **generation_args)
            generated_text = output[0]['generated_text']
         
            if "```python" in generated_text:
                code_start = generated_text.find("```python") + 9
                code_end = generated_text.find("```", code_start)
                if code_end == -1:
                    code = generated_text[code_start:]
                else:
                    code = generated_text[code_start:code_end]
            else:
                code = generated_text
         
            return code.strip()
         
        except Exception as e:
            return f"# –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞: {str(e)}\n# –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑\nprint(df.describe())"

    def generate_drilling_code(self, query: str, selected_option: Optional[Dict] = None) -> str: 
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —à–∞—Ö–º–∞—Ç–∫–∏ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∏ –ö–í–ß –ø–æ –±—É—Ä–µ–Ω–∏—é.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –°—Ç—Ä–æ–∫–∞ —Å –∫–æ–¥–æ–º –∞–Ω–∞–ª–∏–∑–∞
        """
        pipe = get_model_pipe()
        
        try:
            if selected_option:
                modified_query = f"{query} (—Ñ–æ–∫—É—Å –Ω–∞: {selected_option['title']} - {selected_option['description']})"
            else:
                modified_query = query
            
            system_prompt = """–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç Python –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö —Å pandas.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–µ –Ω–µ—Ñ—Ç–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            –ü–∏—à–∏ –¢–û–õ–¨–ö–û PYTHON –ö–û–î –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã–º –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú DataFrame.
            –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π 'df'.
            """
         
            user_prompt = f"""–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç DataFrame –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É: "{query} "
            
            –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•:
            DataFrame —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ (–ò–°–ü–û–õ–¨–ó–£–ô –¢–û–ß–ù–û –¢–ê–ö–ò–ï –ñ–ï –ù–ê–ó–í–ê–ù–ò–Ø):
            1. "–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ" - –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ—Ñ—Ç–∏ (object/string) - –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ë–ï–†–ï–ó–ò–ù–°–ö–û–ï"
            2. "–ì–æ—Ä–∏–∑–æ–Ω—Ç" - –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç –¥–æ–±—ã—á–∏ (object/string, –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏), —Å–æ–¥–µ—Ä–∂–∏—Ç –ú–ò–ù–£–ò–ú–£–ú –î–í–ï –ë–£–ö–í–´, –ï–°–õ–¨ –ú–ù–ï–¨–®–ï - –≠–¢–û –ù–ï –ì–û–†–ò–ó–û–ù–¢!
            3. "–ë–ï" - –±–∏–∑–Ω–µ—Å-–µ–¥–∏–Ω–∏—Ü–∞ (object/string) - –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ï-14 –¶–ü–ü–°'
            4. "‚Ññ —Å–∫–≤" - –Ω–æ–º–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã (object/string), –∏–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä 172s
            5. "–ë—Ä–∏–≥–∞–¥–∞" - –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã –∏ —Ü–µ—Ö–∞ (object/string), –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ –¶–î–ù–ì-2"
            6. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), Q–∂,  –º3/—Å—É—Ç" - —Ä–µ–∂–∏–º–Ω—ã–π –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ (float64)
            7. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), Q–Ω, —Ç/—Å—É—Ç" - —Ä–µ–∂–∏–º–Ω—ã–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (float64)
            8. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), %" - –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–∂–∏–º–µ (float64)
            9. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), T, —Å—É—Ç" - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–∂–∏–º–µ (float64)
            10. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), Q–∂,  –º3/—Å—É—Ç" - –∑–∞–º–µ—Ä–Ω—ã–π –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            11. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), Q–Ω, —Ç/—Å—É—Ç" - –∑–∞–º–µ—Ä–Ω—ã–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            12. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), %" - –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–º–µ—Ä–Ω–∞—è –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            13. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), T, —Å—É—Ç" - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –∑–∞–º–µ—Ä–Ω–æ–µ –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            14. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), Q–∂,  –º3/—Å—É—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ (float64)
            15. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), Q–Ω, —Ç/—Å—É—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (float64)
            16. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), %" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å (float64)
            17. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), T, —Å—É—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (float64)
            18. "ŒîQ–Ω, –ó–∞–º. - –†–µ–∂." - —Ä–∞–∑–Ω–æ—Å—Ç—å –∑–∞–º–µ—Ä–Ω–æ–≥–æ –∏ —Ä–µ–∂–∏–º–Ω–æ–≥–æ –¥–µ–±–∏—Ç–∞ –Ω–µ—Ñ—Ç–∏ (float64)
            19. "ŒîQ–Ω, –§–∞–∫—Ç - –†–µ–∂–∏–º" - —Ä–∞–∑–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ —Ä–µ–∂–∏–º–Ω–æ–≥–æ –¥–µ–±–∏—Ç–∞ –Ω–µ—Ñ—Ç–∏ (float64)
            20. "–ö –ø—Ä–∏–≤. –Ω–µ—Ñ—Ç—å" - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è –Ω–µ—Ñ—Ç–∏ (object)
            21. "–ö –ø—Ä–∏–≤. –≤–æ–¥–∞" - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è –≤–æ–¥—ã (object)
            22. "–ö–£" - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ (object)
            23. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –†–µ–∂–∏–º, —Ç" - –¥–æ–±—ã—á–∞ –Ω–µ—Ñ—Ç–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø–æ —Ä–µ–∂–∏–º—É (float64)
            24. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –ó–∞–º–µ—Ä., —Ç" - –¥–æ–±—ã—á–∞ –Ω–µ—Ñ—Ç–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø–æ –∑–∞–º–µ—Ä–∞–º (float64)
            25. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –§–∞–∫—Ç, —Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–±—ã—á–∞ –Ω–µ—Ñ—Ç–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ (float64)
            26. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –û—Ç–∫–ª –∑–∞–º–µ—Ä - —Ä–µ–∂." - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–∏ –æ—Ç —Ä–µ–∂–∏–º–Ω–æ–π (float64)
            27. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –û—Ç–∫–ª —Ñ–∞–∫—Ç-—Ä–µ–∂–∏–º" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–±—ã—á–∏ –æ—Ç —Ä–µ–∂–∏–º–Ω–æ–π (float64)
            28. "–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ó–∞–º–µ—Ä–Ω–∞—è-–†–µ–∂–∏–º, Q–∂ –¥–µ–±–∏—Ç —Å–∫–≤–∞–∂–∏–Ω—ã, –º3" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–µ–±–∏—Ç–∞ –∂–∏–¥–∫–æ—Å—Ç–∏ (float64)
            29. "–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ó–∞–º–µ—Ä–Ω–∞—è-–†–µ–∂–∏–º, –¢ –ø–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç—ã, —Å—É—Ç" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã (float64)
            
            –í–ê–ñ–ù–û:
            1. –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π DataFrame 'df'.
            2. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô pd.DataFrame() –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
            3. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–û–ï –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞, –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è.
            4. –î–∞–Ω–Ω—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –Ω–µ—Ñ—Ç–µ–¥–æ–±—ã—á–µ, –≥–¥–µ:
               - Q–∂ - –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ (–Ω–µ—Ñ—Ç—å + –≤–æ–¥–∞)
               - Q–Ω - –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (—á–∏—Å—Ç–∞—è –Ω–µ—Ñ—Ç—å)
               - % - –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å (–¥–æ–ª—è –≤–æ–¥—ã –≤ –¥–æ–±—ã–≤–∞–µ–º–æ–π –∂–∏–¥–∫–æ—Å—Ç–∏)
               - T - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–∫–≤–∞–∂–∏–Ω—ã –≤ —Å—É—Ç–∫–∞—Ö
               - –¢–û - —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
               - –ö–£ - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            5. –ß–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —É–∂–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –≤ float64, –Ω–æ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å NaN –∑–Ω–∞—á–µ–Ω–∏—è.
            6. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–æ–ª–±—Ü—ã "–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ", "–ì–æ—Ä–∏–∑–æ–Ω—Ç", "–ë—Ä–∏–≥–∞–¥–∞", "‚Ññ —Å–∫–≤".        
            7. –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–µ–±–∏—Ç–æ–≤ –æ–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–Ω—ã–º–∏, –∑–∞–º–µ—Ä–Ω—ã–º–∏ –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
            8. –°—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫–∏ —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç
            9. –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π **–ø–æ–∏—Å–∫ –ø–æ –≤—Ö–æ–∂–¥–µ–Ω–∏—é**: `.str.contains(..., case=False, na=False)`, —á—Ç–æ–±—ã —É—á–µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è –≤ –∑–∞–ø–∏—Å–∏.
            DataFrame —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é 'df'.
            –í—ã–≤–æ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ print().
            –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π matplotlib —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏ –æ—Å–µ–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ –ª–µ–≥–µ–Ω–¥–æ–π.
            """
         
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]
         
            generation_args = {
                "max_new_tokens": 10000,
                "return_full_text": False,
                "temperature": 0.0,
                "top_p": 0.9,
                "do_sample": False
            }
         
            output = pipe(messages, **generation_args)
            generated_text = output[0]['generated_text']
         
            if "```python" in generated_text:
                code_start = generated_text.find("```python") + 9
                code_end = generated_text.find("```", code_start)
                if code_end == -1:
                    code = generated_text[code_start:]
                else:
                    code = generated_text[code_start:code_end]
            else:
                code = generated_text
         
            return code.strip()
         
        except Exception as e:
            return f"# –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞: {str(e)}\n# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\nimport numpy as np\nprint('–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–±–∏—Ç–∞–º:')\nprint(df.describe())"

    def generate_measurement_code(self, query: str, selected_option: Optional[Dict] = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–∞–∑–∞.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –°—Ç—Ä–æ–∫–∞ —Å –∫–æ–¥–æ–º –∞–Ω–∞–ª–∏–∑–∞
        """
        pipe = get_model_pipe()
        
        try:
            if selected_option:
                modified_query = f"{query} (—Ñ–æ–∫—É—Å –Ω–∞: {selected_option['title']} - {selected_option['description']})"
            else:
                modified_query = query
            
            system_prompt = """–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç Python –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö —Å pandas.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ–±—ã—á–µ –∏ –ø–æ—Å—Ç–∞–≤–∫–µ –≥–∞–∑–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            –ü–∏—à–∏ –¢–û–õ–¨–ö–û PYTHON –ö–û–î –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã–º –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú DataFrame.
            –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π 'df'.
            """
         
            user_prompt = f"""–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç DataFrame –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É: "{query}"
            
            –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•:
            DataFrame —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ (–ò–°–ü–û–õ–¨–ó–£–ô –¢–û–ß–ù–û –¢–ê–ö–ò–ï –ñ–ï –ù–ê–ó–í–ê–ù–ò–Ø):
            1. "–ú–µ—Å—è—Ü" - –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "YYYY-MM-DD 00:00:00", —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ (object)
            2. "–ì–∞–∑ –ù–ì–î–£,\n—Ç—ã—Å. –º3 –í—Å–µ–≥–æ" - –æ–±—ä–µ–º –≥–∞–∑–∞ –ù–ì–î–£
            3. "–î–æ–±—ã—á–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ü–ª–∞–Ω" - –ø–ª–∞–Ω–æ–≤—ã–π –æ–±—ä–µ–º –¥–æ–±—ã—á–∏ –≥–∞–∑–∞
            4. "–î–æ–±—ã—á–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –§–∞–∫—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä–µ–º –¥–æ–±—ã—á–∏ –≥–∞–∑–∞
            5. "–î–æ–±—ã—á–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –ø–ª–∞–Ω–∞
            6. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í—Å–µ–≥–æ –ü–ª–∞–Ω" - –ø–ª–∞–Ω–æ–≤—ã–π –æ–±—ä–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –Ω–∞ –ë–ì–ü–ó
            7. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í—Å–µ–≥–æ –§–∞–∫—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –Ω–∞ –ë–ì–ü–ó
            8. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í—Å–µ–≥–æ –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –ø–ª–∞–Ω–∞
            9. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –ü–æ–ø—É—Ç–Ω—ã–π –Ω–µ—Ñ—Ç—è–Ω–æ–π –≥–∞–∑ –ü–ª–∞–Ω" - –ø–ª–∞–Ω –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–ø—É—Ç–Ω–æ–≥–æ –≥–∞–∑–∞
            10. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –ü–æ–ø—É—Ç–Ω—ã–π –Ω–µ—Ñ—Ç—è–Ω–æ–π –≥–∞–∑ –§–∞–∫—Ç" - —Ñ–∞–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–ø—É—Ç–Ω–æ–≥–æ –≥–∞–∑–∞
            11. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –ü–æ–ø—É—Ç–Ω—ã–π –Ω–µ—Ñ—Ç—è–Ω–æ–π –≥–∞–∑ –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–ø—É—Ç–Ω–æ–≥–æ –≥–∞–∑–∞
            12. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –û—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ñ—Ç–∏ –ü–ª–∞–Ω" - –ø–ª–∞–Ω –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –æ—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
            13. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –û—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ñ—Ç–∏ –§–∞–∫—Ç" - —Ñ–∞–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –æ—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
            14. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –û—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ñ—Ç–∏ –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –æ—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
            15. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –ì–∞–∑ –æ—Ç–¥—É–≤–∫–∏ –ö-1 –ü–ª–∞–Ω" - –ø–ª–∞–Ω –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –æ—Ç–¥—É–≤–∫–∏ –ö-1
            16. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –ì–∞–∑ –æ—Ç–¥—É–≤–∫–∏ –ö-1 –§–∞–∫—Ç" - —Ñ–∞–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –æ—Ç–¥—É–≤–∫–∏ –ö-1
            17. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ë–ì–ü–ó –í —Ç–æ–º —á–∏—Å–ª–µ –ì–∞–∑ –æ—Ç–¥—É–≤–∫–∏ –ö-1 –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –≥–∞–∑–∞ –æ—Ç–¥—É–≤–∫–∏ –ö-1
            18. '–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 "–ù—É–∂–¥—ã –ë–ì–ü–ó" - —Å—ã—Ä–æ–π –≥–∞–∑ –ü–ª–∞–Ω' - –ø–ª–∞–Ω –ø–æ—Å—Ç–∞–≤–∫–∏ —Å—ã—Ä–æ–≥–æ –≥–∞–∑–∞ –Ω–∞ –Ω—É–∂–¥—ã –ë–ì–ü–ó
            19. '–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 "–ù—É–∂–¥—ã –ë–ì–ü–ó" - —Å—ã—Ä–æ–π –≥–∞–∑ –§–∞–∫—Ç' - —Ñ–∞–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ —Å—ã—Ä–æ–≥–æ –≥–∞–∑–∞ –Ω–∞ –Ω—É–∂–¥—ã –ë–ì–ü–ó
            20. '–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 "–ù—É–∂–¥—ã –ë–ì–ü–ó" - —Å—ã—Ä–æ–π –≥–∞–∑ –û—Ç–∫–ª-–µ' - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ —Å—ã—Ä–æ–≥–æ –≥–∞–∑–∞ –Ω–∞ –Ω—É–∂–¥—ã –ë–ì–ü–ó
            21. '–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ì–ü "–ë–µ–ª–æ—Ä—É—Å–Ω–µ—Ñ—Ç—å-–ü—Ä–æ–º—Å–µ—Ä–≤–∏—Å" (–ù–°–ü "–í–∏—à–∞") –ü–ª–∞–Ω' - –ø–ª–∞–Ω –ø–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ –ì–ü
            22. '–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ì–ü "–ë–µ–ª–æ—Ä—É—Å–Ω–µ—Ñ—Ç—å-–ü—Ä–æ–º—Å–µ—Ä–≤–∏—Å" (–ù–°–ü "–í–∏—à–∞") –§–∞–∫—Ç' - —Ñ–∞–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ –ì–ü
            23. '–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ì–ü "–ë–µ–ª–æ—Ä—É—Å–Ω–µ—Ñ—Ç—å-–ü—Ä–æ–º—Å–µ—Ä–≤–∏—Å" (–ù–°–ü "–í–∏—à–∞") –û—Ç–∫–ª-–µ' - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ –ì–ü
            24. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ü—Ä–æ—á–∏–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –ü–ª–∞–Ω" - –ø–ª–∞–Ω –ø–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ—á–∏–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º
            25. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ü—Ä–æ—á–∏–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –§–∞–∫—Ç" - —Ñ–∞–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ—á–∏–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º
            26. "–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ü—Ä–æ—á–∏–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ—á–∏–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º
            27. "–ü–æ—Ç–µ—Ä–∏ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ü–ª–∞–Ω" - –ø–ª–∞–Ω–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏ –≥–∞–∑–∞
            28. "–ü–æ—Ç–µ—Ä–∏ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –§–∞–∫—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Ç–µ—Ä–∏ –≥–∞–∑–∞
            29. "–ü–æ—Ç–µ—Ä–∏ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤—ã—Ö –ø–æ—Ç–µ—Ä—å –≥–∞–∑–∞
            30. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω—É–∂–¥—ã –ù–ì–î–£ –ü–ª–∞–Ω" - –ø–ª–∞–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω—É–∂–¥—ã
            31. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω—É–∂–¥—ã –ù–ì–î–£ –§–∞–∫—Ç" - —Ñ–∞–∫—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω—É–∂–¥—ã
            32. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω—É–∂–¥—ã –ù–ì–î–£ –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω—É–∂–¥—ã
            33. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ñ—Ç–∏ –ü–ª–∞–Ω" - –ø–ª–∞–Ω –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            34. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ñ—Ç–∏ –§–∞–∫—Ç" - —Ñ–∞–∫—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            35. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ñ—Ç–∏ –û—Ç–∫–ª-–µ" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            36. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –í—Å–µ–≥–æ –ü–ª–∞–Ω" - –æ–±—â–∏–π –ø–ª–∞–Ω —Å—É—Ö–æ–≥–æ –≥–∞–∑–∞
            37. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –í—Å–µ–≥–æ –§–∞–∫—Ç" - –æ–±—â–∏–π —Ñ–∞–∫—Ç —Å—É—Ö–æ–≥–æ –≥–∞–∑–∞
            38. "–°—É—Ö–æ–π –≥–∞–∑, —Ç—ã—Å. –º3 –í—Å–µ–≥–æ –û—Ç–∫–ª-–µ" - –æ–±—â–µ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ —Å—É—Ö–æ–≥–æ –≥–∞–∑–∞
            
            –í–ê–ñ–ù–û:
            1. –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π DataFrame 'df'.
            2. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô pd.DataFrame() –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
            3. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–û–ï –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞, –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è.
            
            4. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç:
               - –ö–æ–ª–æ–Ω–∫–∞ "–ú–µ—Å—è—Ü" —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ (object)
               - –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ –º–µ—Å—è—Ü–∞–º —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–π: df["–ú–µ—Å—è—Ü"] = pd.to_datetime(df["–ú–µ—Å—è—Ü"])
               - –¢–µ–∫—É—â–∏–π –≥–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: 2024 (–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π 2024 –≥–æ–¥, –µ—Å–ª–∏ —è–≤–Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω –¥—Ä—É–≥–æ–π)
               - –ó–∞—Ç–µ–º –∏–∑–≤–ª–µ–∫–∞–π –º–µ—Å—è—Ü/–≥–æ–¥: df["–ú–µ—Å—è—Ü"].dt.month –∏–ª–∏ df["–ú–µ—Å—è—Ü"].dt.year
            
            5. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–≤–∞—Ä—Ç–∞–ª–æ–≤:
               - –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:
                 * Q1 (–ö–≤–∞—Ä—Ç–∞–ª 1): –º–µ—Å—è—Ü—ã 1-3 (–Ø–Ω–≤–∞—Ä—å-–ú–∞—Ä—Ç)
                 * Q2 (–ö–≤–∞—Ä—Ç–∞–ª 2): –º–µ—Å—è—Ü—ã 4-6 (–ê–ø—Ä–µ–ª—å-–ò—é–Ω—å)
                 * Q3 (–ö–≤–∞—Ä—Ç–∞–ª 3): –º–µ—Å—è—Ü—ã 7-9 (–ò—é–ª—å-–°–µ–Ω—Ç—è–±—Ä—å)
                 * Q4 (–ö–≤–∞—Ä—Ç–∞–ª 4): –º–µ—Å—è—Ü—ã 10-12 (–û–∫—Ç—è–±—Ä—å-–î–µ–∫–∞–±—Ä—å)
               - –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ —Å –Ω–æ–º–µ—Ä–æ–º –∫–≤–∞—Ä—Ç–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π:
                 df["–ö–≤–∞—Ä—Ç–∞–ª"] = df["–ú–µ—Å—è—Ü"].dt.quarter
               - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π pd.PeriodIndex –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –∫–≤–∞—Ä—Ç–∞–ª–∞:
                 df["–ö–≤–∞—Ä—Ç–∞–ª"] = pd.PeriodIndex(df["–ú–µ—Å—è—Ü"], freq='Q')
            
            6. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–∏—Å–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
               - –í–°–ï —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ (object) –∏ —Ç—Ä–µ–±—É—é—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
               - –ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π: pd.to_numeric(df["–ö–æ–ª–æ–Ω–∫–∞"], errors='coerce')
               - –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω—É–ª–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º—ã–µ –≤ —á–∏—Å–ª–∞
               - –ü–æ—Å–ª–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–π –Ω–∞ NaN: df["–ö–æ–ª–æ–Ω–∫–∞"].isna().sum()
            
            7. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ –∫–∞–≤—ã—á–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
               - df['–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 "–ù—É–∂–¥—ã –ë–ì–ü–ó" - —Å—ã—Ä–æ–π –≥–∞–∑ –§–∞–∫—Ç']
               - df['–ü–æ—Å—Ç–∞–≤–∫–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ì–ü "–ë–µ–ª–æ—Ä—É—Å–Ω–µ—Ñ—Ç—å-–ü—Ä–æ–º—Å–µ—Ä–≤–∏—Å" (–ù–°–ü "–í–∏—à–∞") –ü–ª–∞–Ω']
            
            DataFrame —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é 'df'.
            –í—ã–≤–æ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ print().
            –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π matplotlib —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏ –æ—Å–µ–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ –ª–µ–≥–µ–Ω–¥–æ–π.
            """
         
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]
         
            generation_args = {
                "max_new_tokens": 10000,
                "return_full_text": False,
                "temperature": 0.0,
                "top_p": 0.9,
                "do_sample": False
            }
         
            output = pipe(messages, **generation_args)
            generated_text = output[0]['generated_text']
         
            if "```python" in generated_text:
                code_start = generated_text.find("```python") + 9
                code_end = generated_text.find("```", code_start)
                if code_end == -1:
                    code = generated_text[code_start:]
                else:
                    code = generated_text[code_start:code_end]
            else:
                code = generated_text
         
            return code.strip()
         
        except Exception as e:
            return f"# –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞: {str(e)}\n# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\nprint('–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–∞–∑—É:')\nprint(df.describe())"

    def generate_gas_utilization_code(self, query: str, selected_option: Optional[Dict] = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–µ.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –°—Ç—Ä–æ–∫–∞ —Å –∫–æ–¥–æ–º –∞–Ω–∞–ª–∏–∑–∞
        """
        pipe = get_model_pipe()
        
        try:
            if selected_option:
                modified_query = f"{query} (—Ñ–æ–∫—É—Å –Ω–∞: {selected_option['title']} - {selected_option['description']})"
            else:
                modified_query = query
            
            system_prompt = """–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç Python –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö —Å pandas.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–µ –Ω–µ—Ñ—Ç–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            –ü–∏—à–∏ –¢–û–õ–¨–ö–û PYTHON –ö–û–î –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã–º –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú DataFrame.
            –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π 'df'.
            """
         
            user_prompt = f"""–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç DataFrame –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É: "{query} "
            
            –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•:
            DataFrame —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ (–ò–°–ü–û–õ–¨–ó–£–ô –¢–û–ß–ù–û –¢–ê–ö–ò–ï –ñ–ï –ù–ê–ó–í–ê–ù–ò–Ø):
            1. "–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ" - –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ—Ñ—Ç–∏ (object/string) - –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ë–ï–†–ï–ó–ò–ù–°–ö–û–ï"
            2. "–ì–æ—Ä–∏–∑–æ–Ω—Ç" - –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç –¥–æ–±—ã—á–∏ (object/string, –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏), —Å–æ–¥–µ—Ä–∂–∏—Ç –ú–ò–ù–£–ò–ú–£–ú –î–í–ï –ë–£–ö–í–´, –ï–°–õ–¨ –ú–ù–ï–¨–®–ï - –≠–¢–û –ù–ï –ì–û–†–ò–ó–û–ù–¢!
            3. "–ë–ï" - –±–∏–∑–Ω–µ—Å-–µ–¥–∏–Ω–∏—Ü–∞ (object/string) - –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ï-14 –¶–ü–ü–°'
            4. "‚Ññ —Å–∫–≤" - –Ω–æ–º–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã (object/string), –∏–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä 172s
            5. "–ë—Ä–∏–≥–∞–¥–∞" - –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã –∏ —Ü–µ—Ö–∞ (object/string), –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ –¶–î–ù–ì-2"
            6. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), Q–∂,  –º3/—Å—É—Ç" - —Ä–µ–∂–∏–º–Ω—ã–π –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ (float64)
            7. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), Q–Ω, —Ç/—Å—É—Ç" - —Ä–µ–∂–∏–º–Ω—ã–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (float64)
            8. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), %" - –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–∂–∏–º–µ (float64)
            9. "–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), T, —Å—É—Ç" - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–∂–∏–º–µ (float64)
            10. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), Q–∂,  –º3/—Å—É—Ç" - –∑–∞–º–µ—Ä–Ω—ã–π –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            11. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), Q–Ω, —Ç/—Å—É—Ç" - –∑–∞–º–µ—Ä–Ω—ã–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            12. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), %" - –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–º–µ—Ä–Ω–∞—è –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            13. "–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), T, —Å—É—Ç" - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –∑–∞–º–µ—Ä–Ω–æ–µ –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û (float64)
            14. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), Q–∂,  –º3/—Å—É—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ (float64)
            15. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), Q–Ω, —Ç/—Å—É—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (float64)
            16. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), %" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å (float64)
            17. "–§–∞–∫—Ç (–¥–µ–±–∏—Ç), T, —Å—É—Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (float64)
            18. "ŒîQ–Ω, –ó–∞–º. - –†–µ–∂." - —Ä–∞–∑–Ω–æ—Å—Ç—å –∑–∞–º–µ—Ä–Ω–æ–≥–æ –∏ —Ä–µ–∂–∏–º–Ω–æ–≥–æ –¥–µ–±–∏—Ç–∞ –Ω–µ—Ñ—Ç–∏ (float64)
            19. "ŒîQ–Ω, –§–∞–∫—Ç - –†–µ–∂–∏–º" - —Ä–∞–∑–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ —Ä–µ–∂–∏–º–Ω–æ–≥–æ –¥–µ–±–∏—Ç–∞ –Ω–µ—Ñ—Ç–∏ (float64)
            20. "–ö –ø—Ä–∏–≤. –Ω–µ—Ñ—Ç—å" - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è –Ω–µ—Ñ—Ç–∏ (object)
            21. "–ö –ø—Ä–∏–≤. –≤–æ–¥–∞" - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è –≤–æ–¥—ã (object)
            22. "–ö–£" - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ (object)
            23. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –†–µ–∂–∏–º, —Ç" - –¥–æ–±—ã—á–∞ –Ω–µ—Ñ—Ç–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø–æ —Ä–µ–∂–∏–º—É (float64)
            24. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –ó–∞–º–µ—Ä., —Ç" - –¥–æ–±—ã—á–∞ –Ω–µ—Ñ—Ç–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø–æ –∑–∞–º–µ—Ä–∞–º (float64)
            25. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –§–∞–∫—Ç, —Ç" - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–±—ã—á–∞ –Ω–µ—Ñ—Ç–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ (float64)
            26. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –û—Ç–∫–ª –∑–∞–º–µ—Ä - —Ä–µ–∂." - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–∏ –æ—Ç —Ä–µ–∂–∏–º–Ω–æ–π (float64)
            27. "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–æ–±—ã—á–∞), –û—Ç–∫–ª —Ñ–∞–∫—Ç-—Ä–µ–∂–∏–º" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–±—ã—á–∏ –æ—Ç —Ä–µ–∂–∏–º–Ω–æ–π (float64)
            28. "–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ó–∞–º–µ—Ä–Ω–∞—è-–†–µ–∂–∏–º, Q–∂ –¥–µ–±–∏—Ç —Å–∫–≤–∞–∂–∏–Ω—ã, –º3" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–µ–±–∏—Ç–∞ –∂–∏–¥–∫–æ—Å—Ç–∏ (float64)
            29. "–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ó–∞–º–µ—Ä–Ω–∞—è-–†–µ–∂–∏–º, –¢ –ø–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç—ã, —Å—É—Ç" - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã (float64)
            
            –í–ê–ñ–ù–û:
            1. –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–æ–≤—ã–π DataFrame –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π DataFrame 'df'.
            2. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô pd.DataFrame() –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
            3. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–û–ï –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞, –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è.
            4. –î–∞–Ω–Ω—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –Ω–µ—Ñ—Ç–µ–¥–æ–±—ã—á–µ, –≥–¥–µ:
               - Q–∂ - –¥–µ–±–∏—Ç –∂–∏–¥–∫–æ—Å—Ç–∏ (–Ω–µ—Ñ—Ç—å + –≤–æ–¥–∞)
               - Q–Ω - –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (—á–∏—Å—Ç–∞—è –Ω–µ—Ñ—Ç—å)
               - % - –æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å (–¥–æ–ª—è –≤–æ–¥—ã –≤ –¥–æ–±—ã–≤–∞–µ–º–æ–π –∂–∏–¥–∫–æ—Å—Ç–∏)
               - T - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–∫–≤–∞–∂–∏–Ω—ã –≤ —Å—É—Ç–∫–∞—Ö
               - –¢–û - —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
               - –ö–£ - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            5. –ß–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —É–∂–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –≤ float64, –Ω–æ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å NaN –∑–Ω–∞—á–µ–Ω–∏—è.
            6. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–æ–ª–±—Ü—ã "–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ", "–ì–æ—Ä–∏–∑–æ–Ω—Ç", "–ë—Ä–∏–≥–∞–¥–∞", "‚Ññ —Å–∫–≤".        
            7. –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–µ–±–∏—Ç–æ–≤ –æ–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–Ω—ã–º–∏, –∑–∞–º–µ—Ä–Ω—ã–º–∏ –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
            8. –°—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫–∏ —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç
            9. –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π **–ø–æ–∏—Å–∫ –ø–æ –≤—Ö–æ–∂–¥–µ–Ω–∏—é**: `.str.contains(..., case=False, na=False)`, —á—Ç–æ–±—ã —É—á–µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è –≤ –∑–∞–ø–∏—Å–∏.
            DataFrame —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é 'df'.
            –í—ã–≤–æ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ print().
            –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π matplotlib —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏ –æ—Å–µ–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ –ª–µ–≥–µ–Ω–¥–æ–π.
            """
         
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]
         
            generation_args = {
                "max_new_tokens": 10000,
                "return_full_text": False,
                "temperature": 0.0,
                "top_p": 0.9,
                "do_sample": False
            }
         
            output = pipe(messages, **generation_args)
            generated_text = output[0]['generated_text']
         
            if "```python" in generated_text:
                code_start = generated_text.find("```python") + 9
                code_end = generated_text.find("```", code_start)
                if code_end == -1:
                    code = generated_text[code_start:]
                else:
                    code = generated_text[code_start:code_end]
            else:
                code = generated_text
         
            return code.strip()
         
        except Exception as e:
            return f"# –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞: {str(e)}\n# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\nimport numpy as np\nprint('–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–±–∏—Ç–∞–º:')\nprint(df.describe())"

    def generate_final_response(self, state: AgentState) -> str:
        """
        –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –°—Ç—Ä–æ–∫–∞ ‚Äî –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ —Ñ–æ—Ä–º—É–ª–∞–º–∏.
        """
        selected_option = None
        if state.get("selected_report") and state.get("report_options"):
            for option in state["report_options"]:
                if option["id"] == state["selected_report"]:
                    selected_option = option
                    break

        context = f"""–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ.

–ü–†–ê–í–ò–õ–ê –î–õ–Ø –§–û–†–ú–£–õ –ò –ü–û–Ø–°–ù–ï–ù–ò–ô:
1. –û–±—ã—á–Ω—ã–µ —á–∏—Å–ª–∞ –ø–∏—à–∏ –∫–∞–∫ —Ç–µ–∫—Å—Ç: "–¥–µ–±–∏—Ç 25.5 —Ç/—Å—É—Ç"
2. –§–æ—Ä–º—É–ª—ã –∑–∞–∫–ª—é—á–∞–π –≤ $...$ 
3. –í –ø–æ—è—Å–Ω–µ–Ω–∏—è—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π –ù–û–†–ú–ê–õ–¨–ù–´–ï —Å–∫–æ–±–∫–∏ –¥–ª—è –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è
4. –ü–∏—à–∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ç–∏—Ä–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏: "Q ‚Äî –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (–≤ —Ç/—Å—É—Ç)"

–ü–†–ò–ú–ï–†:
$Q = \\frac{{V}}{{t}}$

–≥–¥–µ:
- Q ‚Äî –¥–µ–±–∏—Ç –Ω–µ—Ñ—Ç–∏ (–≤ —Ç/—Å—É—Ç)
- V ‚Äî –æ–±—ä–µ–º –Ω–µ—Ñ—Ç–∏ (–≤ —Ç–æ–Ω–Ω–∞—Ö) 
- t ‚Äî –≤—Ä–µ–º—è (–≤ —Å—É—Ç–∫–∞—Ö)

        –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {state['user_input']}
        –¢–∏–ø –æ—Ç—á–µ—Ç–∞: {state['route_decision']}
        –í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç—á–µ—Ç–∞: {selected_option['title'] if selected_option else '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑'}
        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
        {state['analysis_result']}

        –û–±—ä—è—Å–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º, –æ—Ç–≤–µ—á–∞—è –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞.
        """

        messages = [
            {"role": "system", "content": context},
            {"role": "user", "content": f"–û–±—ä—è—Å–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: {state['user_input']}"}
        ]

        return self.ai_service.generate_response(messages, max_tokens=5000, temperature=0.1)


class WorkPlanNode(BaseNode):
    """–£–∑–µ–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –ø–ª–∞–Ω–∞–º —Ä–∞–±–æ—Ç."""

    def __init__(self, ai_service: AIService, data_service: DataService):
        super().__init__(ai_service)
        self.data_service = data_service
        self.code_generator = CodeGeneratorNode(ai_service)

    def __call__(self, state: AgentState) -> AgentState:
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω–æ–≤, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∏ –≥—Ä–∞—Ñ–∏–∫ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω).
    
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        """
        work_plan_df, _ = self.data_service.load_work_plan_data()

        selected_option = None
        if state.get("selected_report") and state.get("report_options"):
            for option in state["report_options"]:
                if option["id"] == state["selected_report"]:
                    selected_option = option
                    break

        df_info = f"""
–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö: {work_plan_df.dtypes}
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(work_plan_df)}
–°—Ç–æ–ª–±—Ü—ã: {list(work_plan_df.columns)}
"""

        status_placeholder = st.empty()
        status_placeholder.info("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ø–ª–∞–Ω–æ–≤ —Ä–∞–±–æ—Ç—ã...")

        session_id = st.session_state.get('session_id', 'default')
        generated_code = queue_aware_generation(session_id, 'generate_work_plan_code', {
            'query': state['user_input'],
            'df_info': df_info,
            'selected_option': selected_option
        })

        status_placeholder.info("‚öôÔ∏è –í—ã–ø–æ–ª–Ω—è—é –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...")

        result_text, plot_path, code = execute_generated_code(generated_code, work_plan_df)

        summary_type = selected_option['title'] if selected_option else "–ü–ª–∞–Ω —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–æ–º—ã—Å–ª–∞—Ö"

        status_placeholder.info("üí≠ –§–æ—Ä–º–∏—Ä—É—é –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç...")

        state["analysis_code"] = code
        state["analysis_result"] = result_text
        state["plot_path"] = plot_path or ""
        state["summary_type"] = summary_type
        state["waiting_for_selection"] = False

        state["generated_data"] = {
            "data_source": "work_plan_analysis",
            "selected_option": selected_option,
            "has_visualization": bool(plot_path),
            "status_placeholder": status_placeholder
        }

        return state


class DrillingReportNode(BaseNode):
    """–£–∑–µ–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —à–∞—Ö–º–∞—Ç–∫–∏ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∏ –ö–í–ß (–æ—Ç—á–µ—Ç—ã –ø–æ –±—É—Ä–µ–Ω–∏—é)."""

    def __init__(self, ai_service: AIService, data_service: DataService):
        super().__init__(ai_service)
        self.data_service = data_service
        self.code_generator = CodeGeneratorNode(ai_service)

    def __call__(self, state: AgentState) -> AgentState:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –æ –±—É—Ä–µ–Ω–∏–∏"""
        drilling_df, message = self.data_service.load_drilling_data()
        if drilling_df is None:
            st.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —à–∞—Ö–º–∞—Ç–∫–∏. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.")
            drilling_df = pd.DataFrame({
                'id': ['#1', '#2'],
                'well': ['126', '127'],
                'field': ['–í–ò–®–ê–ù–°–ö–û–ï', '–°–ï–í–ï–†–ù–û–ï'],
                'date': [pd.Timestamp('2024-08-01'), pd.Timestamp('2024-08-02')],
                'plotnost': ['1.05', '1.10'],
                'plotnost_itog': ['–ù–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π', '–ï—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è'],
                'kvch': ['0.85', '0.90'],
                'kvch_itog': ['–ù–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π', '–ù–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π']
            })

        selected_option = None
        if state.get("selected_report") and state.get("report_options"):
            for option in state["report_options"]:
                if option["id"] == state["selected_report"]:
                    selected_option = option
                    break

        status_placeholder = st.empty()
        status_placeholder.info("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –±—É—Ä–µ–Ω–∏—é...")

        session_id = st.session_state.get('session_id', 'default')
        generated_code = queue_aware_generation(session_id, 'generate_drilling_code', {
            'query': state['user_input'],
            'selected_option': selected_option
        })

        status_placeholder.info("‚öôÔ∏è –í—ã–ø–æ–ª–Ω—è—é –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...")

        result_text, plot_path, code = execute_generated_code(generated_code, drilling_df)

        summary_type = selected_option['title'] if selected_option else "–®–∞—Ö–º–∞—Ç–∫–∞ –ø—Ä–æ–± –ø–æ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∏ –ö–í–ß"

        status_placeholder.info("üí≠ –§–æ—Ä–º–∏—Ä—É—é –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç...")

        state["analysis_code"] = code
        state["analysis_result"] = result_text
        state["plot_path"] = plot_path or ""
        state["summary_type"] = summary_type
        state["waiting_for_selection"] = False

        state["generated_data"] = {
            "data_source": "drilling_analysis",
            "selected_option": selected_option,
            "has_visualization": bool(plot_path),
            "status_placeholder": status_placeholder
        }

        return state


class MeasurementReportNode(BaseNode):
    """–£–∑–µ–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–µ –Ω–µ—Ñ—Ç–∏."""

    def __init__(self, ai_service: AIService, data_service: DataService):
        super().__init__(ai_service)
        self.data_service = data_service
        self.code_generator = CodeGeneratorNode(ai_service)

    def __call__(self, state: AgentState) -> AgentState:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –æ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–µ"""
        measurement_df, message = self.data_service.load_measurement_data()
        if measurement_df is None:
            st.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–∏. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.")
            measurement_df = pd.DataFrame({
                '–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ': ['–ë–ï–†–ï–ó–ò–ù–°–ö–û–ï', '–°–ï–í–ï–†–ù–û–ï', '–í–û–°–¢–û–ß–ù–û–ï'],
                '‚Ññ —Å–∫–≤': ['152', '234', '345'],
                '–†–µ–∂–∏–º (–¥–µ–±–∏—Ç), Q–Ω, —Ç/—Å—É—Ç': [13.0, 25.5, 18.2],
                '–ó–∞–º–µ—Ä–Ω–∞—è (–¥–µ–±–∏—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –¢–û), Q–Ω, —Ç/—Å—É—Ç': [12.5, 24.8, 17.9],
                '–§–∞–∫—Ç (–¥–µ–±–∏—Ç), Q–Ω, —Ç/—Å—É—Ç': [12.1, 24.2, 17.5]
            })

        selected_option = None
        if state.get("selected_report") and state.get("report_options"):
            for option in state["report_options"]:
                if option["id"] == state["selected_report"]:
                    selected_option = option
                    break

        status_placeholder = st.empty()
        status_placeholder.info("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–∏...")

        session_id = st.session_state.get('session_id', 'default')
        generated_code = queue_aware_generation(session_id, 'generate_measurement_code', {
            'query': state['user_input'],
            'selected_option': selected_option
        })

        status_placeholder.info("‚öôÔ∏è –í—ã–ø–æ–ª–Ω—è—é –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...")

        result_text, plot_path, code = execute_generated_code(generated_code, measurement_df)

        summary_type = selected_option['title'] if selected_option else "–û—Ç—á—ë—Ç –ø–æ –∑–∞–º–µ—Ä–Ω–æ–π –¥–æ–±—ã—á–µ –∑–∞ –ø–µ—Ä–∏–æ–¥"

        status_placeholder.info("üí≠ –§–æ—Ä–º–∏—Ä—É—é –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç...")

        state["analysis_code"] = code
        state["analysis_result"] = result_text
        state["plot_path"] = plot_path or ""
        state["summary_type"] = summary_type
        state["waiting_for_selection"] = False

        state["generated_data"] = {
            "data_source": "measurement_analysis",
            "selected_option": selected_option,
            "has_visualization": bool(plot_path),
            "status_placeholder": status_placeholder
        }

        return state


class GasUtilizationNode(BaseNode):
    """–£–∑–µ–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –¥–æ–±—ã—á–µ –∏ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–∞–∑–∞."""

    def __init__(self, ai_service: AIService, data_service: DataService):
        super().__init__(ai_service)
        self.data_service = data_service
        self.code_generator = CodeGeneratorNode(ai_service)

    def __call__(self, state: AgentState) -> AgentState:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –æ–± —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–∞–∑–∞"""
        gas_df, message = self.data_service.load_gas_utilization_data()
        if gas_df is None:
            st.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–∞–∑–∞. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.")
            gas_df = pd.DataFrame({
                '–ú–µ—Å—è—Ü': ['2024-01-01', '2024-02-01', '2024-03-01'],
                '–î–æ–±—ã—á–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ü–ª–∞–Ω': ['100', '120', '110'],
                '–î–æ–±—ã—á–∞ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –§–∞–∫—Ç': ['105', '115', '108'],
                '–ü–æ—Ç–µ—Ä–∏ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –ü–ª–∞–Ω': ['5', '6', '5.5'],
                '–ü–æ—Ç–µ—Ä–∏ –≥–∞–∑–∞, —Ç—ã—Å. –º3 –§–∞–∫—Ç': ['4.8', '5.9', '5.2']
            })

        selected_option = None
        if state.get("selected_report") and state.get("report_options"):
            for option in state["report_options"]:
                if option["id"] == state["selected_report"]:
                    selected_option = option
                    break

        status_placeholder = st.empty()
        status_placeholder.info("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–∞–∑–∞...")

        session_id = st.session_state.get('session_id', 'default')
        generated_code = queue_aware_generation(session_id, 'generate_gas_utilization_code', {
            'query': state['user_input'],
            'selected_option': selected_option
        })

        status_placeholder.info("‚öôÔ∏è –í—ã–ø–æ–ª–Ω—è—é –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...")

        result_text, plot_path, code = execute_generated_code(generated_code, gas_df)

        summary_type = selected_option['title'] if selected_option else "–û—Ç—á—ë—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–∞–∑–∞"

        status_placeholder.info("üí≠ –§–æ—Ä–º–∏—Ä—É—é –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç...")

        state["analysis_code"] = code
        state["analysis_result"] = result_text
        state["plot_path"] = plot_path or ""
        state["summary_type"] = summary_type
        state["waiting_for_selection"] = False

        state["generated_data"] = {
            "data_source": "gas_utilization_analysis",
            "selected_option": selected_option,
            "has_visualization": bool(plot_path),
            "status_placeholder": status_placeholder
        }

        return state


class DocumentationNode(BaseNode):
    """–£–∑–µ–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."""

    def __init__(self, ai_service: AIService, search_service: SearchService):
        super().__init__(ai_service)
        self.search_service = search_service

    def __call__(self, state: AgentState) -> AgentState:
        """
        –ò—â–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ –∏—Ö –æ—Å–Ω–æ–≤–µ.

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º
        """
        user_query = state['user_input']

        status_placeholder = st.empty()
        status_placeholder.info("üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...")

        doc_results = self.search_service.search_documentation(user_query)

        status_placeholder.info("üí≠ –§–æ—Ä–º–∏—Ä—É—é –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...")

        session_id = st.session_state.get('session_id', 'default')
        response = queue_aware_generation(session_id, 'generate_documentation_response', {
            'query': user_query,
            'doc_results': [doc.__dict__ for doc in doc_results]
        })

        status_placeholder.empty()

        state["response"] = response
        state["doc_results"] = [doc.__dict__ for doc in doc_results]
        state["summary_type"] = "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã"
        state["analysis_code"] = ""
        state["analysis_result"] = ""
        state["plot_path"] = ""
        state["waiting_for_selection"] = False
        state["generated_data"] = {
            "data_source": "documentation_search",
            "found_docs": len(doc_results),
            "status_placeholder": status_placeholder
        }

        return state


class GeneralNode(BaseNode):
    """–£–∑–µ–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—â–∏—Ö (–Ω–µ—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö) –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

    def __call__(self, state: AgentState) -> AgentState:
         """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –æ—Ç—á–µ—Ç–∞–º–∏ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.
    
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞
        """
        response = self.ai_service.generate_general_response(state['user_input'])

        state["response"] = response
        state["summary_type"] = "–û–±—â–∏–π –≤–æ–ø—Ä–æ—Å"
        state["waiting_for_selection"] = False
        state["analysis_code"] = ""
        state["analysis_result"] = ""
        state["plot_path"] = ""
        state["generated_data"] = {"data_source": "general_response"}

        return state


class ResponseGeneratorNode(BaseNode):
    """–§–∏–Ω–∞–ª—å–Ω—ã–π —É–∑–µ–ª: —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏."""

    def __call__(self, state: AgentState) -> AgentState:
        """
        –ó–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É: –æ—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞.
    
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ø–æ–ª–µ–º 'response'
        """
        if state.get("generated_data") and "status_placeholder" in state["generated_data"]:
            state["generated_data"]["status_placeholder"].empty()

        if state["route_decision"] not in ["general", "documentation"]:
            if "response" not in state or not state["response"]:
                code_generator = CodeGeneratorNode(self.ai_service)
                state["response"] = code_generator.generate_final_response(state)

        return state